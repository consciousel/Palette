{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  Object.defineProperty(o, k2, {\n    enumerable: true,\n    get: function () {\n      return m[k];\n    }\n  });\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\n\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\n\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n\n  __setModuleDefault(result, mod);\n\n  return result;\n};\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst lodash_1 = __importDefault(require(\"lodash\"));\n\nconst utils = __importStar(require(\"./utils\"));\n\nconst ripple_keypairs_1 = __importDefault(require(\"ripple-keypairs\"));\n\nconst ripple_binary_codec_1 = __importDefault(require(\"ripple-binary-codec\"));\n\nconst hashes_1 = require(\"../common/hashes\");\n\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\n\nconst common_1 = require(\"../common\");\n\nconst validate = utils.common.validate;\n\nfunction computeSignature(tx, privateKey, signAs) {\n  const signingData = signAs ? ripple_binary_codec_1.default.encodeForMultisigning(tx, signAs) : ripple_binary_codec_1.default.encodeForSigning(tx);\n  return ripple_keypairs_1.default.sign(signingData, privateKey);\n}\n\nfunction signWithKeypair(api, txJSON, keypair) {\n  let options = arguments.length > 3 && arguments[3] !== undefined ? arguments[3] : {\n    signAs: ''\n  };\n  validate.sign({\n    txJSON,\n    keypair\n  });\n  const tx = JSON.parse(txJSON);\n\n  if (tx.TxnSignature || tx.Signers) {\n    throw new utils.common.errors.ValidationError('txJSON must not contain \"TxnSignature\" or \"Signers\" properties');\n  }\n\n  checkFee(api, tx.Fee);\n  const txToSignAndEncode = Object.assign({}, tx);\n  txToSignAndEncode.SigningPubKey = options.signAs ? '' : keypair.publicKey;\n\n  if (options.signAs) {\n    const signer = {\n      Account: options.signAs,\n      SigningPubKey: keypair.publicKey,\n      TxnSignature: computeSignature(txToSignAndEncode, keypair.privateKey, options.signAs)\n    };\n    txToSignAndEncode.Signers = [{\n      Signer: signer\n    }];\n  } else {\n    txToSignAndEncode.TxnSignature = computeSignature(txToSignAndEncode, keypair.privateKey);\n  }\n\n  const serialized = ripple_binary_codec_1.default.encode(txToSignAndEncode);\n  checkTxSerialization(serialized, tx);\n  return {\n    signedTransaction: serialized,\n    id: hashes_1.computeBinaryTransactionHash(serialized)\n  };\n}\n\nfunction objectDiff(a, b) {\n  const diffs = {};\n\n  const compare = function (i1, i2, k) {\n    const type1 = Object.prototype.toString.call(i1);\n    const type2 = Object.prototype.toString.call(i2);\n\n    if (type2 === '[object Undefined]') {\n      diffs[k] = null;\n      return;\n    }\n\n    if (type1 !== type2) {\n      diffs[k] = i2;\n      return;\n    }\n\n    if (type1 === '[object Object]') {\n      const objDiff = objectDiff(i1, i2);\n\n      if (Object.keys(objDiff).length > 0) {\n        diffs[k] = objDiff;\n      }\n\n      return;\n    }\n\n    if (type1 === '[object Array]') {\n      if (!lodash_1.default.isEqual(i1, i2)) {\n        diffs[k] = i2;\n      }\n\n      return;\n    }\n\n    if (type1 === '[object Function]') {\n      if (i1.toString() !== i2.toString()) {\n        diffs[k] = i2;\n      }\n\n      return;\n    }\n\n    if (i1 !== i2) {\n      diffs[k] = i2;\n    }\n  };\n\n  for (const key in a) {\n    if (a.hasOwnProperty(key)) {\n      compare(a[key], b[key], key);\n    }\n  }\n\n  for (const key in b) {\n    if (b.hasOwnProperty(key)) {\n      if (!a[key] && a[key] !== b[key]) {\n        diffs[key] = b[key];\n      }\n    }\n  }\n\n  return diffs;\n}\n\nfunction checkTxSerialization(serialized, tx) {\n  var _a;\n\n  const decoded = ripple_binary_codec_1.default.decode(serialized);\n\n  if (!decoded.TxnSignature && !decoded.Signers) {\n    throw new utils.common.errors.ValidationError('Serialized transaction must have a TxnSignature or Signers property');\n  }\n\n  delete decoded.TxnSignature;\n  delete decoded.Signers;\n\n  if (!tx.SigningPubKey) {\n    delete decoded.SigningPubKey;\n  }\n\n  (_a = tx.Memos) === null || _a === void 0 ? void 0 : _a.map(memo => {\n    var _a, _b, _c;\n\n    if ((_a = memo === null || memo === void 0 ? void 0 : memo.Memo) === null || _a === void 0 ? void 0 : _a.MemoData) {\n      memo.Memo.MemoData = memo.Memo.MemoData.toUpperCase();\n    }\n\n    if ((_b = memo === null || memo === void 0 ? void 0 : memo.Memo) === null || _b === void 0 ? void 0 : _b.MemoType) {\n      memo.Memo.MemoType = memo.Memo.MemoType.toUpperCase();\n    }\n\n    if ((_c = memo === null || memo === void 0 ? void 0 : memo.Memo) === null || _c === void 0 ? void 0 : _c.MemoFormat) {\n      memo.Memo.MemoFormat = memo.Memo.MemoFormat.toUpperCase();\n    }\n\n    return memo;\n  });\n\n  if (!lodash_1.default.isEqual(decoded, tx)) {\n    const error = new utils.common.errors.ValidationError('Serialized transaction does not match original txJSON. See `error.data`');\n    error.data = {\n      decoded,\n      tx,\n      diff: objectDiff(tx, decoded)\n    };\n    throw error;\n  }\n}\n\nfunction checkFee(api, txFee) {\n  const fee = new bignumber_js_1.default(txFee);\n  const maxFeeDrops = common_1.xrpToDrops(api._maxFeeXRP);\n\n  if (fee.isGreaterThan(maxFeeDrops)) {\n    throw new utils.common.errors.ValidationError(`\"Fee\" should not exceed \"${maxFeeDrops}\". ` + 'To use a higher fee, set `maxFeeXRP` in the RippleAPI constructor.');\n  }\n}\n\nfunction sign(txJSON, secret, options, keypair) {\n  if (typeof secret === 'string') {\n    validate.sign({\n      txJSON,\n      secret\n    });\n    return signWithKeypair(this, txJSON, ripple_keypairs_1.default.deriveKeypair(secret), options);\n  } else {\n    if (!keypair && !secret) {\n      throw new utils.common.errors.ValidationError('sign: Missing secret or keypair.');\n    }\n\n    return signWithKeypair(this, txJSON, keypair ? keypair : secret, options);\n  }\n}\n\nexports.default = sign;","map":{"version":3,"mappings":"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","names":["validate","utils","common","computeSignature","tx","privateKey","signAs","signingData","ripple_binary_codec_1","encodeForMultisigning","encodeForSigning","ripple_keypairs_1","sign","signWithKeypair","api","txJSON","keypair","options","JSON","parse","TxnSignature","Signers","errors","ValidationError","checkFee","Fee","txToSignAndEncode","Object","assign","SigningPubKey","publicKey","signer","Account","Signer","serialized","encode","checkTxSerialization","signedTransaction","id","hashes_1","objectDiff","a","b","diffs","compare","i1","i2","k","type1","prototype","toString","call","type2","objDiff","keys","length","lodash_1","isEqual","key","hasOwnProperty","decoded","decode","Memos","_a","map","memo","Memo","MemoData","toUpperCase","_b","MemoType","_c","MemoFormat","error","data","diff","txFee","fee","bignumber_js_1","maxFeeDrops","common_1","_maxFeeXRP","isGreaterThan","secret","deriveKeypair","exports"],"sourceRoot":"","sources":["../../../src/transaction/sign.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}