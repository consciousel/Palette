{"ast":null,"code":"'use strict';\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.extendContracts = void 0;\n\nconst debug = require('debug')('thor:injector');\n\nconst Subscription = require('web3-core-subscriptions').subscription;\n\nconst utils = require(\"../utils\");\n\nconst formatters_1 = require(\"./formatters\");\n\nconst extendContracts = function (web3) {\n  const _encodeEventABI = web3.eth.Contract.prototype._encodeEventABI;\n\n  web3.eth.Contract.prototype._encodeEventABI = function (event, options) {\n    debug('_encodeEventABI');\n\n    const result = _encodeEventABI.call(this, event, options);\n\n    if (options.options) {\n      result.options = options.options;\n    }\n\n    if (options.range) {\n      result.range = options.range;\n    }\n\n    if (options.order) {\n      result.order = options.order;\n    }\n\n    return result;\n  };\n\n  web3.eth.Contract.prototype._on = function () {\n    debug('_on'); // keeps the code from web3\n\n    const subOptions = this._generateEventOptions.apply(this, arguments); // prevent the event \"newListener\" and \"removeListener\" from being overwritten\n\n\n    this._checkListener('newListener', subOptions.event.name, subOptions.callback);\n\n    this._checkListener('removeListener', subOptions.event.name, subOptions.callback); // TODO check if listener already exists? and reuse subscription if options are the same.\n    // create new subscription\n\n    /* changes from web3 starts the following\n     */\n    // subscription options in thor doesn't support array as topic filter object\n\n\n    const filterOptions = {\n      address: subOptions.params.address\n    };\n\n    if (subOptions.params.fromBlock) {\n      filterOptions.pos = utils.validBytes32OrError(subOptions.params.fromBlock, '[thorify] fromBlock must be blockID');\n    }\n\n    debug('Contract filter option: %O', filterOptions);\n\n    if (subOptions.params.topics) {\n      for (const [index, value] of subOptions.params.topics.entries()) {\n        if (value === null) {\n          continue;\n        }\n\n        if (typeof value === 'string') {\n          filterOptions['t' + index] = value;\n        } else {\n          throw new Error('[thorify] Array filter option is not supported in thor, must be null or bytes32 string');\n        }\n      }\n    }\n\n    const decodeEventABI = this._decodeEventABI.bind(subOptions.event);\n\n    const subscription = new Subscription({\n      subscription: {\n        params: 1,\n        inputFormatter: [formatters_1.inputLogFilterFormatter],\n\n        subscriptionHandler(subscriptionMsg) {\n          if (subscriptionMsg.error) {\n            this.emit('error', subscriptionMsg.error); // web3-core-subscriptions/subscription sets a default value for this.callback\n\n            this.callback(subscriptionMsg.error, null, this);\n          } else {\n            const result = decodeEventABI(subscriptionMsg.data);\n\n            if (result.removed) {\n              this.emit('changed', result);\n            } else {\n              this.emit('data', result);\n            } // web3-core-subscriptions/subscription sets a default value for this.callback\n\n\n            this.callback(null, result, this);\n          }\n        }\n\n      },\n      type: 'eth',\n      requestManager: this._requestManager\n    });\n    subscription.subscribe('logs', filterOptions, subOptions.callback || function () {});\n    return subscription;\n  };\n};\n\nexports.extendContracts = extendContracts;","map":{"version":3,"mappings":"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","names":["debug","require","Subscription","subscription","extendContracts","web3","_encodeEventABI","eth","Contract","prototype","event","options","result","call","range","order","_on","subOptions","_generateEventOptions","apply","arguments","_checkListener","name","callback","filterOptions","address","params","fromBlock","pos","utils","validBytes32OrError","topics","index","value","entries","Error","decodeEventABI","_decodeEventABI","bind","inputFormatter","formatters_1","subscriptionHandler","subscriptionMsg","error","emit","data","removed","type","requestManager","_requestManager","subscribe","exports"],"sourceRoot":"","sources":["../../src/extend/contracts.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}