{"ast":null,"code":"import { publicKeyToAddress } from './cry/address';\nimport { blake2b256 } from './cry/blake2b';\nimport { secp256k1 } from './cry/secp256k1';\nimport { RLP } from './rlp';\n/** Transaction class defines VeChainThor's multi-clause transaction */\n\nexport class Transaction {\n  /**\n   * construct a transaction object with given body\n   * @param body body of tx\n   */\n  constructor(body) {\n    this.body = Object.assign({}, body);\n  }\n  /** decode from Buffer to transaction\n   * @param raw encoded buffer\n   * @param unsigned to indicator if the encoded buffer contains signature\n   */\n\n\n  static decode(raw, unsigned) {\n    let body;\n    let signature;\n\n    if (unsigned) {\n      body = unsignedTxRLP.decode(raw);\n    } else {\n      const decoded = txRLP.decode(raw);\n      signature = decoded.signature;\n      delete decoded.signature;\n      body = decoded;\n    }\n\n    const reserved = body.reserved;\n\n    if (reserved.length > 0) {\n      if (reserved[reserved.length - 1].length === 0) {\n        throw new Error('invalid reserved fields: not trimmed');\n      }\n\n      const features = featuresKind.buffer(reserved[0], 'reserved.features').decode();\n      body.reserved = {\n        features\n      };\n\n      if (reserved.length > 1) {\n        body.reserved.unused = reserved.slice(1);\n      }\n    } else {\n      delete body.reserved;\n    }\n\n    const tx = new Transaction(body);\n\n    if (signature) {\n      tx.signature = signature;\n    }\n\n    return tx;\n  }\n  /**\n   * returns transaction ID\n   * null returned if something wrong (e.g. invalid signature)\n   */\n\n\n  get id() {\n    if (!this._signatureValid) {\n      return null;\n    }\n\n    try {\n      const signingHash = this.signingHash();\n      const pubKey = secp256k1.recover(signingHash, this.signature.slice(0, 65));\n      const origin = publicKeyToAddress(pubKey);\n      return '0x' + blake2b256(signingHash, origin).toString('hex');\n    } catch (_a) {\n      return null;\n    }\n  }\n  /**\n   * compute signing hashes.\n   * It returns tx hash for origin or delegator depends on param `delegateFor`.\n   * @param delegateFor address of intended tx origin. If set, the returned hash is for delegator to sign.\n   */\n\n\n  signingHash(delegateFor) {\n    const reserved = this._encodeReserved();\n\n    const buf = unsignedTxRLP.encode(Object.assign(Object.assign({}, this.body), {\n      reserved\n    }));\n    const hash = blake2b256(buf);\n\n    if (delegateFor) {\n      if (!/^0x[0-9a-f]{40}$/i.test(delegateFor)) {\n        throw new Error('delegateFor expected address');\n      }\n\n      return blake2b256(hash, Buffer.from(delegateFor.slice(2), 'hex'));\n    }\n\n    return hash;\n  }\n  /** returns tx origin. null returned if no signature or not incorrectly signed */\n\n\n  get origin() {\n    if (!this._signatureValid) {\n      return null;\n    }\n\n    try {\n      const signingHash = this.signingHash();\n      const pubKey = secp256k1.recover(signingHash, this.signature.slice(0, 65));\n      return '0x' + publicKeyToAddress(pubKey).toString('hex');\n    } catch (_a) {\n      return null;\n    }\n  }\n  /** returns tx delegator. null returned if no signature or not incorrectly signed */\n\n\n  get delegator() {\n    if (!this.delegated) {\n      return null;\n    }\n\n    if (!this._signatureValid) {\n      return null;\n    }\n\n    const origin = this.origin;\n\n    if (!origin) {\n      return null;\n    }\n\n    try {\n      const signingHash = this.signingHash(origin);\n      const pubKey = secp256k1.recover(signingHash, this.signature.slice(65));\n      return '0x' + publicKeyToAddress(pubKey).toString('hex');\n    } catch (_a) {\n      return null;\n    }\n  }\n  /** returns whether delegated. see https://github.com/vechain/VIPs/blob/master/vips/VIP-191.md */\n\n\n  get delegated() {\n    // tslint:disable-next-line:no-bitwise\n    return (((this.body.reserved || {}).features || 0) & Transaction.DELEGATED_MASK) === Transaction.DELEGATED_MASK;\n  }\n  /** returns intrinsic gas it takes */\n\n\n  get intrinsicGas() {\n    return Transaction.intrinsicGas(this.body.clauses);\n  }\n  /** encode into Buffer */\n\n\n  encode() {\n    const reserved = this._encodeReserved();\n\n    if (this.signature) {\n      return txRLP.encode(Object.assign(Object.assign({}, this.body), {\n        reserved,\n        signature: this.signature\n      }));\n    }\n\n    return unsignedTxRLP.encode(Object.assign(Object.assign({}, this.body), {\n      reserved\n    }));\n  }\n\n  _encodeReserved() {\n    const reserved = this.body.reserved || {};\n    const list = [featuresKind.data(reserved.features || 0, 'reserved.features').encode(), ...(reserved.unused || [])]; // trim\n\n    while (list.length > 0) {\n      if (list[list.length - 1].length === 0) {\n        list.pop();\n      } else {\n        break;\n      }\n    }\n\n    return list;\n  }\n\n  get _signatureValid() {\n    const expectedSigLen = this.delegated ? 65 * 2 : 65;\n    return this.signature ? this.signature.length === expectedSigLen : false;\n  }\n\n}\nTransaction.DELEGATED_MASK = 1;\n\n(function (Transaction) {\n  /**\n   * calculates intrinsic gas that a tx costs with the given clauses.\n   * @param clauses\n   */\n  function intrinsicGas(clauses) {\n    const txGas = 5000;\n    const clauseGas = 16000;\n    const clauseGasContractCreation = 48000;\n\n    if (clauses.length === 0) {\n      return txGas + clauseGas;\n    }\n\n    return clauses.reduce((sum, c) => {\n      if (c.to) {\n        sum += clauseGas;\n      } else {\n        sum += clauseGasContractCreation;\n      }\n\n      sum += dataGas(c.data);\n      return sum;\n    }, txGas);\n  }\n\n  Transaction.intrinsicGas = intrinsicGas;\n\n  function dataGas(data) {\n    const zgas = 4;\n    const nzgas = 68;\n    let sum = 0;\n\n    for (let i = 2; i < data.length; i += 2) {\n      if (data.substr(i, 2) === '00') {\n        sum += zgas;\n      } else {\n        sum += nzgas;\n      }\n    }\n\n    return sum;\n  }\n})(Transaction || (Transaction = {}));\n\nconst unsignedTxRLP = new RLP({\n  name: 'tx',\n  kind: [{\n    name: 'chainTag',\n    kind: new RLP.NumericKind(1)\n  }, {\n    name: 'blockRef',\n    kind: new RLP.CompactFixedBlobKind(8)\n  }, {\n    name: 'expiration',\n    kind: new RLP.NumericKind(4)\n  }, {\n    name: 'clauses',\n    kind: {\n      item: [{\n        name: 'to',\n        kind: new RLP.NullableFixedBlobKind(20)\n      }, {\n        name: 'value',\n        kind: new RLP.NumericKind(32)\n      }, {\n        name: 'data',\n        kind: new RLP.BlobKind()\n      }]\n    }\n  }, {\n    name: 'gasPriceCoef',\n    kind: new RLP.NumericKind(1)\n  }, {\n    name: 'gas',\n    kind: new RLP.NumericKind(8)\n  }, {\n    name: 'dependsOn',\n    kind: new RLP.NullableFixedBlobKind(32)\n  }, {\n    name: 'nonce',\n    kind: new RLP.NumericKind(8)\n  }, {\n    name: 'reserved',\n    kind: {\n      item: new RLP.BufferKind()\n    }\n  }]\n});\nconst txRLP = new RLP({\n  name: 'tx',\n  kind: [...unsignedTxRLP.profile.kind, {\n    name: 'signature',\n    kind: new RLP.BufferKind()\n  }]\n});\nconst featuresKind = new RLP.NumericKind(4);","map":{"version":3,"mappings":"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","names":["publicKeyToAddress","blake2b256","secp256k1","RLP","Transaction","constructor","body","Object","decode","raw","unsigned","signature","unsignedTxRLP","decoded","txRLP","reserved","length","Error","features","featuresKind","buffer","unused","slice","tx","id","_signatureValid","signingHash","pubKey","recover","origin","toString","delegateFor","_encodeReserved","buf","encode","hash","test","Buffer","from","delegator","delegated","DELEGATED_MASK","intrinsicGas","clauses","list","data","pop","expectedSigLen","txGas","clauseGas","clauseGasContractCreation","reduce","sum","c","to","dataGas","zgas","nzgas","i","substr","name","kind","NumericKind","CompactFixedBlobKind","item","NullableFixedBlobKind","BlobKind","BufferKind","profile"],"sourceRoot":"","sources":["../src/transaction.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}