{"ast":null,"code":"import { publicKeyToAddress } from './cry/address';\nimport { blake2b256 } from './cry/blake2b';\nimport { secp256k1 } from './cry/secp256k1';\n\nconst fastJsonStableStringify = require('fast-json-stable-stringify');\n\nexport var Certificate;\n\n(function (Certificate) {\n  function safeToLowerCase(str) {\n    return typeof str === 'string' ? str.toLowerCase() : str;\n  }\n  /**\n   * deterministically encode cert into JSON\n   * @param cert cert object\n   */\n\n\n  function encode(cert) {\n    return fastJsonStableStringify(Object.assign(Object.assign({}, cert), {\n      signer: safeToLowerCase(cert.signer),\n      signature: cert.signature ? safeToLowerCase(cert.signature) : cert.signature\n    }));\n  }\n\n  Certificate.encode = encode;\n  /**\n   * verify the cert\n   * @param cert cert object with signature\n   */\n\n  function verify(cert) {\n    if (!cert.signature) {\n      throw new Error('signature missing');\n    }\n\n    const signature = cert.signature;\n\n    if (!/^0x[0-9a-f]+$/i.test(signature) || signature.length % 2 !== 0) {\n      throw new Error('invalid signature');\n    }\n\n    const encoded = encode(Object.assign(Object.assign({}, cert), {\n      signature: undefined\n    }));\n    const signingHash = blake2b256(encoded);\n    const pubKey = secp256k1.recover(signingHash, Buffer.from(signature.slice(2), 'hex'));\n\n    if ('0x' + publicKeyToAddress(pubKey).toString('hex') !== safeToLowerCase(cert.signer)) {\n      throw new Error('signature does not match with signer');\n    }\n  }\n\n  Certificate.verify = verify;\n})(Certificate || (Certificate = {}));","map":{"version":3,"mappings":"AAAA,SAASA,kBAAT,QAAmC,eAAnC;AACA,SAASC,UAAT,QAA2B,eAA3B;AACA,SAASC,SAAT,QAA0B,iBAA1B;;AAEA,MAAMC,uBAAuB,GAAGC,OAAO,CAAC,4BAAD,CAAvC;;AAmBA,OAAM,IAAWC,WAAX;;AAAN,WAAiBA,WAAjB,EAA4B;AACxB,WAASC,eAAT,CAAyBC,GAAzB,EAAoC;AAChC,WAAO,OAAOA,GAAP,KAAe,QAAf,GAA0BA,GAAG,CAACC,WAAJ,EAA1B,GAA8CD,GAArD;AACH;AACD;;;;;;AAIA,WAAgBE,MAAhB,CAAuBC,IAAvB,EAAwC;AACpC,WAAOP,uBAAuB,iCACvBO,IADuB,GACnB;AACPC,YAAM,EAAEL,eAAe,CAACI,IAAI,CAACC,MAAN,CADhB;AAEPC,eAAS,EAAEF,IAAI,CAACE,SAAL,GAAiBN,eAAe,CAACI,IAAI,CAACE,SAAN,CAAhC,GAAmDF,IAAI,CAACE;AAF5D,KADmB,EAA9B;AAKH;;AANeP,uBAAMI,MAAN;AAQhB;;;;;AAIA,WAAgBI,MAAhB,CAAuBH,IAAvB,EAAwC;AACpC,QAAI,CAACA,IAAI,CAACE,SAAV,EAAqB;AACjB,YAAM,IAAIE,KAAJ,CAAU,mBAAV,CAAN;AACH;;AACD,UAAMF,SAAS,GAAGF,IAAI,CAACE,SAAvB;;AACA,QAAI,CAAC,iBAAiBG,IAAjB,CAAsBH,SAAtB,CAAD,IAAqCA,SAAS,CAACI,MAAV,GAAmB,CAAnB,KAAyB,CAAlE,EAAqE;AACjE,YAAM,IAAIF,KAAJ,CAAU,mBAAV,CAAN;AACH;;AAED,UAAMG,OAAO,GAAGR,MAAM,iCAAMC,IAAN,GAAU;AAAEE,eAAS,EAAEM;AAAb,KAAV,EAAtB;AACA,UAAMC,WAAW,GAAGlB,UAAU,CAACgB,OAAD,CAA9B;AAEA,UAAMG,MAAM,GAAGlB,SAAS,CAACmB,OAAV,CAAkBF,WAAlB,EAA+BG,MAAM,CAACC,IAAP,CAAYX,SAAS,CAACY,KAAV,CAAgB,CAAhB,CAAZ,EAAgC,KAAhC,CAA/B,CAAf;;AAEA,QAAI,OAAOxB,kBAAkB,CAACoB,MAAD,CAAlB,CAA2BK,QAA3B,CAAoC,KAApC,CAAP,KAAsDnB,eAAe,CAACI,IAAI,CAACC,MAAN,CAAzE,EAAwF;AACpF,YAAM,IAAIG,KAAJ,CAAU,sCAAV,CAAN;AACH;AACJ;;AAjBeT,uBAAMQ,MAAN;AAkBnB,CAtCD,EAAiBR,WAAW,KAAXA,WAAW,MAA5B","names":["publicKeyToAddress","blake2b256","secp256k1","fastJsonStableStringify","require","Certificate","safeToLowerCase","str","toLowerCase","encode","cert","signer","signature","verify","Error","test","length","encoded","undefined","signingHash","pubKey","recover","Buffer","from","slice","toString"],"sourceRoot":"","sources":["../src/certificate.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"module"}