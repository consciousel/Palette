{"ast":null,"code":"\"use strict\";\n\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.NumericalBinaryCodec = void 0;\n\nconst typesystem_1 = require(\"../typesystem\");\n\nconst utils_1 = require(\"./utils\");\n\nconst bignumber_js_1 = __importDefault(require(\"bignumber.js\"));\n\nconst constants_1 = require(\"./constants\");\n/**\n * Encodes and decodes \"NumericalValue\" objects\n * with respect to: {@link https://docs.elrond.com/developers/developer-reference/elrond-serialization-format/ | The Elrond Serialization Format}.\n */\n\n\nclass NumericalBinaryCodec {\n  decodeNested(buffer, type) {\n    let offset = 0;\n    let length = type.sizeInBytes;\n\n    if (!length) {\n      // Size of type is not known: arbitrary-size big integer.\n      // Therefore, we must read the length from the header.\n      offset = constants_1.SizeOfU32;\n      length = buffer.readUInt32BE();\n    }\n\n    let payload = buffer.slice(offset, offset + length);\n    let result = this.decodeTopLevel(payload, type);\n    let decodedLength = length + offset;\n    return [result, decodedLength];\n  }\n\n  decodeTopLevel(buffer, type) {\n    let payload = utils_1.cloneBuffer(buffer);\n    let empty = buffer.length == 0;\n\n    if (empty) {\n      return new typesystem_1.NumericalValue(type, new bignumber_js_1.default(0));\n    }\n\n    let isPositive = !type.withSign || utils_1.isMsbZero(payload);\n\n    if (isPositive) {\n      let value = utils_1.bufferToBigInt(payload);\n      return new typesystem_1.NumericalValue(type, value);\n    } // Also see: https://github.com/ElrondNetwork/big-int-util/blob/master/twos-complement/twos2bigint.go\n\n\n    utils_1.flipBufferBitsInPlace(payload);\n    let value = utils_1.bufferToBigInt(payload);\n    let negativeValue = value.multipliedBy(new bignumber_js_1.default(-1));\n    let negativeValueMinusOne = negativeValue.minus(new bignumber_js_1.default(1));\n    return new typesystem_1.NumericalValue(type, negativeValueMinusOne);\n  }\n\n  encodeNested(primitive) {\n    if (primitive.sizeInBytes) {\n      return this.encodeNestedFixedSize(primitive, primitive.sizeInBytes);\n    } // Size is not known: arbitrary-size big integer. Therefore, we must emit the length (as U32) before the actual payload.\n\n\n    let buffer = this.encodeTopLevel(primitive);\n    let length = Buffer.alloc(constants_1.SizeOfU32);\n    length.writeUInt32BE(buffer.length);\n    return Buffer.concat([length, buffer]);\n  }\n\n  encodeNestedFixedSize(primitive, size) {\n    if (primitive.value.isZero()) {\n      return Buffer.alloc(size, 0x00);\n    }\n\n    if (!primitive.withSign) {\n      const buffer = utils_1.bigIntToBuffer(primitive.value);\n      const paddingBytes = Buffer.alloc(size - buffer.length, 0x00);\n      return Buffer.concat([paddingBytes, buffer]);\n    }\n\n    if (primitive.value.isPositive()) {\n      let buffer = utils_1.bigIntToBuffer(primitive.value); // Fix ambiguity if any\n\n      if (utils_1.isMsbOne(buffer)) {\n        buffer = utils_1.prependByteToBuffer(buffer, 0x00);\n      }\n\n      const paddingBytes = Buffer.alloc(size - buffer.length, 0x00);\n      return Buffer.concat([paddingBytes, buffer]);\n    } // Negative:\n    // Also see: https://github.com/ElrondNetwork/big-int-util/blob/master/twos-complement/bigint2twos.go\n\n\n    let valuePlusOne = primitive.value.plus(new bignumber_js_1.default(1));\n    let buffer = utils_1.bigIntToBuffer(valuePlusOne);\n    utils_1.flipBufferBitsInPlace(buffer); // Fix ambiguity if any\n\n    if (utils_1.isMsbZero(buffer)) {\n      buffer = utils_1.prependByteToBuffer(buffer, 0xFF);\n    }\n\n    const paddingBytes = Buffer.alloc(size - buffer.length, 0xff);\n    return Buffer.concat([paddingBytes, buffer]);\n  }\n\n  encodeTopLevel(primitive) {\n    let withSign = primitive.withSign; // Nothing or Zero:\n\n    if (primitive.value.isZero()) {\n      return Buffer.alloc(0);\n    } // I don't care about the sign:\n\n\n    if (!withSign) {\n      return utils_1.bigIntToBuffer(primitive.value);\n    }\n\n    return this.encodePrimitive(primitive);\n  }\n\n  encodePrimitive(primitive) {\n    // Positive:\n    if (primitive.value.isPositive()) {\n      let buffer = utils_1.bigIntToBuffer(primitive.value); // Fix ambiguity if any\n\n      if (utils_1.isMsbOne(buffer)) {\n        buffer = utils_1.prependByteToBuffer(buffer, 0x00);\n      }\n\n      return buffer;\n    } // Negative:\n    // Also see: https://github.com/ElrondNetwork/big-int-util/blob/master/twos-complement/bigint2twos.go\n\n\n    let valuePlusOne = primitive.value.plus(new bignumber_js_1.default(1));\n    let buffer = utils_1.bigIntToBuffer(valuePlusOne);\n    utils_1.flipBufferBitsInPlace(buffer); // Fix ambiguity if any\n\n    if (utils_1.isMsbZero(buffer)) {\n      buffer = utils_1.prependByteToBuffer(buffer, 0xFF);\n    }\n\n    return buffer;\n  }\n\n}\n\nexports.NumericalBinaryCodec = NumericalBinaryCodec;","map":{"version":3,"mappings":"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","names":["NumericalBinaryCodec","decodeNested","buffer","type","offset","length","sizeInBytes","constants_1","readUInt32BE","payload","slice","result","decodeTopLevel","decodedLength","utils_1","empty","typesystem_1","bignumber_js_1","isPositive","withSign","value","negativeValue","multipliedBy","negativeValueMinusOne","minus","encodeNested","primitive","encodeNestedFixedSize","encodeTopLevel","Buffer","alloc","writeUInt32BE","concat","size","isZero","paddingBytes","valuePlusOne","plus","encodePrimitive","exports"],"sourceRoot":"","sources":["../../../src/smartcontracts/codec/numerical.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}