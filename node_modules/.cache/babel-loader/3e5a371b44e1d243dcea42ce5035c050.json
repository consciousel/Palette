{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.Utils = void 0;\n\nvar tslib_1 = require(\"tslib\");\n\nvar clone_1 = tslib_1.__importDefault(require(\"lodash/clone\"));\n\nvar randombytes_1 = tslib_1.__importDefault(require(\"randombytes\"));\n\nvar stellar_base_1 = require(\"stellar-base\");\n\nvar errors_1 = require(\"./errors\");\n\nvar Utils;\n\n(function (Utils) {\n  function buildChallengeTx(serverKeypair, clientAccountID, homeDomain, timeout, networkPassphrase, webAuthDomain, memo) {\n    if (timeout === void 0) {\n      timeout = 300;\n    }\n\n    if (memo === void 0) {\n      memo = null;\n    }\n\n    if (clientAccountID.startsWith(\"M\") && memo) {\n      throw Error(\"memo cannot be used if clientAccountID is a muxed account\");\n    }\n\n    var account = new stellar_base_1.Account(serverKeypair.publicKey(), \"-1\");\n    var now = Math.floor(Date.now() / 1000);\n    var value = randombytes_1.default(48).toString(\"base64\");\n    var builder = new stellar_base_1.TransactionBuilder(account, {\n      fee: stellar_base_1.BASE_FEE,\n      networkPassphrase: networkPassphrase,\n      timebounds: {\n        minTime: now,\n        maxTime: now + timeout\n      }\n    }).addOperation(stellar_base_1.Operation.manageData({\n      name: homeDomain + \" auth\",\n      value: value,\n      source: clientAccountID,\n      withMuxing: true\n    })).addOperation(stellar_base_1.Operation.manageData({\n      name: \"web_auth_domain\",\n      value: webAuthDomain,\n      source: account.accountId()\n    }));\n\n    if (memo) {\n      builder.addMemo(stellar_base_1.Memo.id(memo));\n    }\n\n    var transaction = builder.build();\n    transaction.sign(serverKeypair);\n    return transaction.toEnvelope().toXDR(\"base64\").toString();\n  }\n\n  Utils.buildChallengeTx = buildChallengeTx;\n\n  function readChallengeTx(challengeTx, serverAccountID, networkPassphrase, homeDomains, webAuthDomain) {\n    var _a;\n\n    if (serverAccountID.startsWith(\"M\")) {\n      throw Error(\"Invalid serverAccountID: multiplexed accounts are not supported.\");\n    }\n\n    var transaction;\n\n    try {\n      transaction = new stellar_base_1.Transaction(challengeTx, networkPassphrase, true);\n    } catch (_b) {\n      try {\n        transaction = new stellar_base_1.FeeBumpTransaction(challengeTx, networkPassphrase, true);\n      } catch (_c) {\n        throw new errors_1.InvalidSep10ChallengeError(\"Invalid challenge: unable to deserialize challengeTx transaction string\");\n      }\n\n      throw new errors_1.InvalidSep10ChallengeError(\"Invalid challenge: expected a Transaction but received a FeeBumpTransaction\");\n    }\n\n    var sequence = Number.parseInt(transaction.sequence, 10);\n\n    if (sequence !== 0) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction sequence number should be zero\");\n    }\n\n    if (transaction.source !== serverAccountID) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction source account is not equal to the server's account\");\n    }\n\n    if (transaction.operations.length < 1) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction should contain at least one operation\");\n    }\n\n    var _d = transaction.operations,\n        operation = _d[0],\n        subsequentOperations = _d.slice(1);\n\n    if (!operation.source) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction's operation should contain a source account\");\n    }\n\n    var clientAccountID = operation.source;\n    var memo = null;\n\n    if (transaction.memo.type !== stellar_base_1.MemoNone) {\n      if (clientAccountID.startsWith(\"M\")) {\n        throw new errors_1.InvalidSep10ChallengeError(\"The transaction has a memo but the client account ID is a muxed account\");\n      }\n\n      if (transaction.memo.type !== stellar_base_1.MemoID) {\n        throw new errors_1.InvalidSep10ChallengeError(\"The transaction's memo must be of type `id`\");\n      }\n\n      memo = transaction.memo.value;\n    }\n\n    if (operation.type !== \"manageData\") {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction's operation type should be 'manageData'\");\n    }\n\n    if (transaction.timeBounds && Number.parseInt((_a = transaction.timeBounds) === null || _a === void 0 ? void 0 : _a.maxTime, 10) === stellar_base_1.TimeoutInfinite) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction requires non-infinite timebounds\");\n    }\n\n    if (!validateTimebounds(transaction, 60 * 5)) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction has expired\");\n    }\n\n    if (operation.value === undefined) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction's operation values should not be null\");\n    }\n\n    if (!operation.value) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction's operation value should not be null\");\n    }\n\n    if (Buffer.from(operation.value.toString(), \"base64\").length !== 48) {\n      throw new errors_1.InvalidSep10ChallengeError(\"The transaction's operation value should be a 64 bytes base64 random string\");\n    }\n\n    if (!homeDomains) {\n      throw new errors_1.InvalidSep10ChallengeError(\"Invalid homeDomains: a home domain must be provided for verification\");\n    }\n\n    var matchedHomeDomain;\n\n    if (typeof homeDomains === \"string\") {\n      if (homeDomains + \" auth\" === operation.name) {\n        matchedHomeDomain = homeDomains;\n      }\n    } else if (Array.isArray(homeDomains)) {\n      matchedHomeDomain = homeDomains.find(function (domain) {\n        return domain + \" auth\" === operation.name;\n      });\n    } else {\n      throw new errors_1.InvalidSep10ChallengeError(\"Invalid homeDomains: homeDomains type is \" + typeof homeDomains + \" but should be a string or an array\");\n    }\n\n    if (!matchedHomeDomain) {\n      throw new errors_1.InvalidSep10ChallengeError(\"Invalid homeDomains: the transaction's operation key name does not match the expected home domain\");\n    }\n\n    for (var _i = 0, subsequentOperations_1 = subsequentOperations; _i < subsequentOperations_1.length; _i++) {\n      var op = subsequentOperations_1[_i];\n\n      if (op.type !== \"manageData\") {\n        throw new errors_1.InvalidSep10ChallengeError(\"The transaction has operations that are not of type 'manageData'\");\n      }\n\n      if (op.source !== serverAccountID) {\n        throw new errors_1.InvalidSep10ChallengeError(\"The transaction has operations that are unrecognized\");\n      }\n\n      if (op.name === \"web_auth_domain\") {\n        if (op.value === undefined) {\n          throw new errors_1.InvalidSep10ChallengeError(\"'web_auth_domain' operation value should not be null\");\n        }\n\n        if (op.value.compare(Buffer.from(webAuthDomain))) {\n          throw new errors_1.InvalidSep10ChallengeError(\"'web_auth_domain' operation value does not match \" + webAuthDomain);\n        }\n      }\n    }\n\n    if (!verifyTxSignedBy(transaction, serverAccountID)) {\n      throw new errors_1.InvalidSep10ChallengeError(\"Transaction not signed by server: '\" + serverAccountID + \"'\");\n    }\n\n    return {\n      tx: transaction,\n      clientAccountID: clientAccountID,\n      matchedHomeDomain: matchedHomeDomain,\n      memo: memo\n    };\n  }\n\n  Utils.readChallengeTx = readChallengeTx;\n\n  function verifyChallengeTxThreshold(challengeTx, serverAccountID, networkPassphrase, threshold, signerSummary, homeDomains, webAuthDomain) {\n    var _a;\n\n    var signers = signerSummary.map(function (signer) {\n      return signer.key;\n    });\n    var signersFound = verifyChallengeTxSigners(challengeTx, serverAccountID, networkPassphrase, signers, homeDomains, webAuthDomain);\n    var weight = 0;\n\n    var _loop_1 = function (signer) {\n      var sigWeight = ((_a = signerSummary.find(function (s) {\n        return s.key === signer;\n      })) === null || _a === void 0 ? void 0 : _a.weight) || 0;\n      weight += sigWeight;\n    };\n\n    for (var _i = 0, signersFound_1 = signersFound; _i < signersFound_1.length; _i++) {\n      var signer = signersFound_1[_i];\n\n      _loop_1(signer);\n    }\n\n    if (weight < threshold) {\n      throw new errors_1.InvalidSep10ChallengeError(\"signers with weight \" + weight + \" do not meet threshold \" + threshold + \"\\\"\");\n    }\n\n    return signersFound;\n  }\n\n  Utils.verifyChallengeTxThreshold = verifyChallengeTxThreshold;\n\n  function verifyChallengeTxSigners(challengeTx, serverAccountID, networkPassphrase, signers, homeDomains, webAuthDomain) {\n    var tx = readChallengeTx(challengeTx, serverAccountID, networkPassphrase, homeDomains, webAuthDomain).tx;\n    var serverKP;\n\n    try {\n      serverKP = stellar_base_1.Keypair.fromPublicKey(serverAccountID);\n    } catch (err) {\n      throw new Error(\"Couldn't infer keypair from the provided 'serverAccountID': \" + err.message);\n    }\n\n    var clientSigners = new Set();\n\n    for (var _i = 0, signers_1 = signers; _i < signers_1.length; _i++) {\n      var signer = signers_1[_i];\n\n      if (signer === serverKP.publicKey()) {\n        continue;\n      }\n\n      if (signer.charAt(0) !== \"G\") {\n        continue;\n      }\n\n      clientSigners.add(signer);\n    }\n\n    if (clientSigners.size === 0) {\n      throw new errors_1.InvalidSep10ChallengeError(\"No verifiable client signers provided, at least one G... address must be provided\");\n    }\n\n    var allSigners = tslib_1.__spreadArrays([serverKP.publicKey()], Array.from(clientSigners));\n\n    var signersFound = gatherTxSigners(tx, allSigners);\n\n    if (signersFound.indexOf(serverKP.publicKey()) === -1) {\n      throw new errors_1.InvalidSep10ChallengeError(\"Transaction not signed by server: '\" + serverKP.publicKey() + \"'\");\n    }\n\n    if (signersFound.length === 1) {\n      throw new errors_1.InvalidSep10ChallengeError(\"None of the given signers match the transaction signatures\");\n    }\n\n    if (signersFound.length !== tx.signatures.length) {\n      throw new errors_1.InvalidSep10ChallengeError(\"Transaction has unrecognized signatures\");\n    }\n\n    signersFound.splice(signersFound.indexOf(serverKP.publicKey()), 1);\n    return signersFound;\n  }\n\n  Utils.verifyChallengeTxSigners = verifyChallengeTxSigners;\n\n  function verifyTxSignedBy(transaction, accountID) {\n    return gatherTxSigners(transaction, [accountID]).length !== 0;\n  }\n\n  Utils.verifyTxSignedBy = verifyTxSignedBy;\n\n  function gatherTxSigners(transaction, signers) {\n    var hashedSignatureBase = transaction.hash();\n    var txSignatures = clone_1.default(transaction.signatures);\n    var signersFound = new Set();\n\n    for (var _i = 0, signers_2 = signers; _i < signers_2.length; _i++) {\n      var signer = signers_2[_i];\n\n      if (txSignatures.length === 0) {\n        break;\n      }\n\n      var keypair = void 0;\n\n      try {\n        keypair = stellar_base_1.Keypair.fromPublicKey(signer);\n      } catch (err) {\n        throw new errors_1.InvalidSep10ChallengeError(\"Signer is not a valid address: \" + err.message);\n      }\n\n      for (var i = 0; i < txSignatures.length; i++) {\n        var decSig = txSignatures[i];\n\n        if (!decSig.hint().equals(keypair.signatureHint())) {\n          continue;\n        }\n\n        if (keypair.verify(hashedSignatureBase, decSig.signature())) {\n          signersFound.add(signer);\n          txSignatures.splice(i, 1);\n          break;\n        }\n      }\n    }\n\n    return Array.from(signersFound);\n  }\n\n  Utils.gatherTxSigners = gatherTxSigners;\n\n  function validateTimebounds(transaction, gracePeriod) {\n    if (gracePeriod === void 0) {\n      gracePeriod = 0;\n    }\n\n    if (!transaction.timeBounds) {\n      return false;\n    }\n\n    var now = Math.floor(Date.now() / 1000);\n    var _a = transaction.timeBounds,\n        minTime = _a.minTime,\n        maxTime = _a.maxTime;\n    return now >= Number.parseInt(minTime, 10) - gracePeriod && now <= Number.parseInt(maxTime, 10) + gracePeriod;\n  }\n})(Utils = exports.Utils || (exports.Utils = {}));","map":{"version":3,"mappings":"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","names":["Utils","buildChallengeTx","serverKeypair","clientAccountID","homeDomain","timeout","networkPassphrase","webAuthDomain","memo","startsWith","Error","account","stellar_base_1","publicKey","now","Math","floor","Date","value","randombytes_1","toString","builder","fee","timebounds","minTime","maxTime","addOperation","manageData","name","source","withMuxing","accountId","addMemo","id","transaction","build","sign","toEnvelope","toXDR","readChallengeTx","challengeTx","serverAccountID","homeDomains","errors_1","sequence","Number","parseInt","operations","length","operation","subsequentOperations","type","timeBounds","_a","validateTimebounds","undefined","Buffer","from","matchedHomeDomain","Array","isArray","find","domain","_i","op","compare","verifyTxSignedBy","tx","verifyChallengeTxThreshold","threshold","signerSummary","signers","map","signer","key","signersFound","verifyChallengeTxSigners","weight","sigWeight","s","serverKP","fromPublicKey","err","message","clientSigners","Set","charAt","add","size","allSigners","gatherTxSigners","indexOf","signatures","splice","accountID","hashedSignatureBase","hash","txSignatures","clone_1","keypair","i","decSig","hint","equals","signatureHint","verify","signature","gracePeriod","exports"],"sourceRoot":"","sources":["../src/utils.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}